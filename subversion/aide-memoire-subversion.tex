\documentclass[a4paper,twoside]{article}
\usepackage{autiwa}

\title{Aide mémoire Subversion (svn)}
\author{Autiwa}

\newcommand{\raccourci}[1]{{\bfseries #1}}

\makeindex
\begin{document}

\tableofcontents

\clearpage

\section{Préambule}
Subversion permet de gérer un projet (de programmation généralement) et de garder en mémoire l'historique de toutes les versions d'un ensemble de fichiers. Il permet de gérer un projet à plusieurs, de programmer afin de pouvoir revenir en arrière, comparer avec d'anciennes versions et cie. 

Le principe est d'avoir un serveur subversion (un seul possible) qui va garder en mémoire l'historique de toutes les versions et un client subversion (plusieurs possibles) qui vont se connecter au serveur pour mettre à jour la version des fichiers ou en récupérer les dernières versions.

\begin{remarque}
Il est possible que le serveur soit lui aussi client, dans le cas où il n'y aurait qu'un seul développeur et qu'on ne souhaite pas passer par internet.
\end{remarque}

\section{commandes universelles subversion}
Ici, je note les commandes qui sont valables à la fois pour svn installé sur un serveur internet, ou sur une machine locale pour un usage personnel

\subsection{Mettre à jour sa copie locale}
\begin{verbatim}
svn update
\end{verbatim}

Pour celà, il faut que le dossier dans lequel on se trouve ait déjà été défini comme un dossier svn via un \gras{checkout} (voir \refsec{sec:checkout})

\subsection{Ajouter des fichiers ou dossiers au projet}\index{commande svn!add}
Pour ajouter des fichiers il faut faire :
\begin{verbatim}
svn add latex/ vim/ 
\end{verbatim}
où \textbf{latex/} et \textbf{vim/} sont deux dossiers existant dans le dossier local de référence

\begin{remarque}
Au cas où ça serait pas clair. J'ai créé un dossier \textbf{/home/autiwa/Formulaires} grâce à \refsec{sec:checkout}. Dans ce dossier, j'ai créé et rempli à la main les sous-dossiers \textbf{latex/} et \textbf{vim/}. Maintenant, grâce à la commande ci-dessus, je définis ces sous-dossiers comme étant rattachés au projet. En faisant ainsi le contenu est rajouté récursivement.
\end{remarque}

\begin{attention}
Cette commande n'agit que sur le répertoire local (la \emph{working copy}). Il faut ensuite faire un \textbf{commit} (voir \refsec{sec:commit}) pour valider les changements sur le serveur.
\end{attention}

\subsection{Supprimer des fichiers ou dossiers au projet}\index{commande svn!delete}
Pour supprimer des fichiers il faut faire :
\begin{verbatim}
svn delete latex/ vim/ 
\end{verbatim}
où \textbf{latex/} et \textbf{vim/} sont deux dossiers existant dans le dossier local de référence. 

\begin{attention}
Cette commande n'agit que sur le répertoire local (la \emph{working copy}). Il faut ensuite faire un \textbf{commit} (voir \refsec{sec:commit}) pour valider les changements sur le serveur.
\end{attention}

\begin{remarque}
Supprimer manuellement dans le dossier courant des fichiers n'aura aucune incidence sur le dépot subversion (je crois). Il faut faire avec \texttt{svn delete} si on veut modifier quelque chose.
\end{remarque}

\subsection{Lister les fichiers du dépot}
\begin{verbatim}
svn list
\end{verbatim}
va lister les fichiers présent dans le dépôt, mais par défaut, il fait les fichiers présent lors de la première révision. 

Pour spécifier un numéro de révision (pour peu que les fichiers aient changés entre temps) : 
\begin{verbatim}
svn list -r 7
\end{verbatim}
pour afficher la liste des fichiers de la révision 7.

\subsection{Revenir à une version précédente}
Pour annuler les modifications locales et revenir à la dernière révision : 
\begin{verbatim}
svn revert *.f90
\end{verbatim}
va remettre en l'état tous les fichiers du svn qui sont présents dans le dossier courant (on peut aussi ne préciser qu'un seul fichier).

\bigskip

Si on souhaite forcer la mise à jour vers une révision plus ancienne (en cas de bug) il suffit de préciser le numéro de la révision
\begin{verbatim}
svn update --force -r39
\end{verbatim}
pour revenir à la révision $39$ ou 
\begin{verbatim}
svn update --force -r39 fichier.f90
\end{verbatim}
Pour ne changer qu'un seul fichier en particulier.

\begin{remarque}
Si la révision $39$ est la dernière et qu'elle a été envoyée depuis le répertoire local, il est fort probable que la commande ci-dessus ne change rien. Il faut alors utiliser la commande \texttt{revert}

\texttt{--force} permet de forcer les fichiers de la révision et d'écraser toute éventuelle modification locale. Dans le doute, tester sans cette option, quitte à la rajouter ensuite.
\end{remarque}


\bigskip

On peut aussi supprimer les modifications de certaines révisions, à condition que celles-ci soient indépendantes des révisions plus récentes : 
\begin{verbatim}
svn merge -r2349:2345
\end{verbatim}
ou
\begin{verbatim}
svn merge -r2349:2345 fichier.f90
\end{verbatim}
pour ne modifier qu'un seul fichier (ou un ensemble de fichier restreint.

Cette commande, qui doit être suivie d'un \texttt{commit}, va créer une nouvelle révision qui annule les commit entre 2345 et 2349 pour créer une révision 2350. 

\subsection{Historique des modifications : log}\index{commande!log}\index{historique des modifications}
La commande \texttt{log} permet de voir un historique des commentaires de révision, soit de l'ensemble des fichiers, soit d'un fichier en particulier.

\begin{verbatim}
svn log
\end{verbatim}
affiche l'historique de toutes les révisions (il est possible de spécifier un nombre maximal de lignes que l'on souhaite (les 10 dernières révisions par exemple via l'option \texttt{-l 10}). 

\begin{verbatim}
svn log main.f90
\end{verbatim}
va afficher l'historique des modifications du fichier \textbf{main.f90}, c'est à dire que n'apparaitront que les commentaires des révisions où le fichier \textbf{main.f90} a été modifié.


\section{Subversion sur internet}
Je vais prendre l'exemple de google code, qui est celui que j'ai choisi et que je suis en train d'apprendre.

\subsection{Récupérer le contenu du projet}\label{sec:checkout}\index{commande svn!checkout}
Une fois le projet créé (sur la page \url{http://code.google.com/hosting/createProject}), il faut faire : 
\begin{verbatim}
svn checkout --username autiwa@gmail.com --password "passwd" \
https://autiwa-tutorials.googlecode.com/svn/trunk/ Formulaires
\end{verbatim}

Cette commande permet de récupérer le contenu du projet et de le copier dans un dossier \textbf{Formulaires} qui sera créé dans le dossier courant.

\begin{definition}[Checkout]
Opération d'extraction d'une version d'un projet du repository vers un répertoire de travail local.
\end{definition}


\subsection{Appliquer les changements qu'on vient de faire localement : commit}\label{sec:commit}\index{commande svn!commit}\index{mise à jour local -> serveur}

Pour mettre à jour les versions sur serveur à partir des modifications effectuées localement, il faut : 
\begin{verbatim}
svn commit -m "initialisation" --username autiwa@gmail.com --password passwd
\end{verbatim}
où \textbf{"initialisation"} est le commentaire qui décrit la mise à jour et les modifications effectuées, \textbf{passwd} étant le mot de passe associé à votre identifiant (ici \textbf{autiwa@gmail.com} pour moi).

\begin{remarque}
Je n'ai eu besoin d'entrer le mot de passe que la première fois.
\end{remarque}

\section{Subversion localement}
Le serveur ET le client seront alors sur la même machine.

\subsection{Création du projet}
J'ai créé un dossier \textbf{svn} dans mon \textbf{\$HOME}, puis je fais, dans mon répertoire utilisateur : 
\begin{verbatim}
svnadmin create svn/mercury
\end{verbatim}
pour un projet que j'appelle \textbf{mercury}.

\subsection{Récupérer le contenu du projet}
Une fois le projet créé (sur la page \url{http://code.google.com/hosting/createProject}), il faut faire : 
\begin{verbatim}
svn checkout file:///home/cossou/svn/mercury
\end{verbatim}
où \textbf{file:///home/cossou/svn/mercury} est une URL qui désigne le dossier \textbf{/home/cossou/svn/mercury}. La présente de \textbf{file://} est à ma connaissance indispensable.

Cette commande permet de récupérer le contenu du projet et de le copier dans un dossier \textbf{Formulaires} qui sera créé dans le dossier courant.

\begin{definition}[Checkout]
Opération d'extraction d'une version d'un projet du repository vers un répertoire de travail local.
\end{definition}


\subsection{Appliquer les changements qu'on vient de faire localement : commit}\index{commande svn!commit}\index{mise à jour local -> serveur}

Pour mettre à jour les versions sur serveur à partir des modifications effectuées localement, il faut : 
\begin{verbatim}
svn commit -m "initialisation"
\end{verbatim}
où \textbf{"initialisation"} est le commentaire qui décrit la mise à jour et les modifications effectuées, \textbf{passwd} étant le mot de passe associé à votre identifiant (ici \textbf{autiwa@gmail.com} pour moi).


\section{Importer un arbre subversion}
À la création d'un dépot subversion (sur internet par exemple) on peut souhaiter importer un arbre subversion déjà existant (localement par exemple). Afin de l'importer, il suffit d'avoir le dépôt de destination entièrement vide (pas initialisé). Il peut donc être nécessaire de faire un \emph{reset}. Puis il faut faire 
\begin{verbatim}
svnsync init --username YOURUSERNAME \
https://YOURPROJECT.googlecode.com/svn file:///path/to/localrepos
  Copied properties for revision 0.
\end{verbatim}
pour initialiser le dépôt. Vous aurez alors un retour de cette forme : 
\begin{verbatim}
$ svnsync init --username YOURUSERNAME \
https://mercury-90.googlecode.com/svn file:///home/login/svn/mercury
  Copied properties for revision 0.
\end{verbatim}

Puis il faut synchroniser toutes les révisions locales sur le nouveau dépôt : 
\begin{verbatim}
svnsync sync --username YOURUSERNAME https://YOURPROJECT.googlecode.com/svn
  Committed revision 1.
  Copied properties for revision 1.
  Committed revision 2.
  Copied properties for revision 2.
  [...]
\end{verbatim}

\begin{remarque}
J'ai eu droit à un 
\begin{verbatim}
svnsync: Le serveur a envoyé une valeur inattendue (502 Bad Gateway)
 en réponse à la requête PROPFIND pour '/svn/!svn/bln/21'
\end{verbatim}
J'ai re-exécuté la même commande de synchronisation quelques minutes après et j'ai pu synchroniser, je ne sais pas d'où le problème venait.
\end{remarque}



\end{document}

Mes svn : 
URL : https://autiwa-tutorials.googlecode.com/svn/trunk/
login : autiwa@gmail.com
Description : SVN pour mes formulaires, recettes de cuisines et tutoriaux divers. Il contient même mes paquets LaTeX

URL : https://mercury-90.googlecode.com/svn
Description : SVN pour le code mercury en f90 que je développe.

URL : https://pl3.projectlocker.com/autiwa_py_modules/svn
login : autiwa@gmail.com
Description : SVN pour mes modules python.